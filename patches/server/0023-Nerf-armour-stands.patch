From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Mariell Hoversholm <proximyst@proximyst.com>
Date: Mon, 9 Nov 2020 17:35:46 +0100
Subject: [PATCH] Nerf armour stands

---
 src/main/java/net/minecraft/server/Block.java | 13 +++++++++++++
 .../minecraft/server/EntityArmorStand.java    | 19 +++++++++++++++++++
 .../us/minevict/papercut/PapercutConfig.java  |  9 +++++++++
 3 files changed, 41 insertions(+)

diff --git a/src/main/java/net/minecraft/server/Block.java b/src/main/java/net/minecraft/server/Block.java
index 4b4f14711d483089a5d5478b57539911a9c7a2fc..6d73f04b2215469a10e6d9982df7e05b3dad3093 100644
--- a/src/main/java/net/minecraft/server/Block.java
+++ b/src/main/java/net/minecraft/server/Block.java
@@ -22,6 +22,19 @@ public class Block extends BlockBase implements IMaterial {
     });
     protected final BlockStateList<Block, IBlockData> blockStateList;
     private IBlockData blockData;
+    // Papercut start
+    public final boolean isFence() {
+        return this == Blocks.ACACIA_FENCE ||
+                this == Blocks.BIRCH_FENCE ||
+                this == Blocks.CRIMSON_FENCE ||
+                this == Blocks.DARK_OAK_FENCE ||
+                this == Blocks.JUNGLE_FENCE ||
+                this == Blocks.NETHER_BRICK_FENCE ||
+                this == Blocks.OAK_FENCE ||
+                this == Blocks.SPRUCE_FENCE ||
+                this == Blocks.WARPED_FENCE;
+    }
+    // Papercut end
     // Paper start
     public final boolean isDestroyable() {
         return com.destroystokyo.paper.PaperConfig.allowBlockPermanentBreakingExploits ||
diff --git a/src/main/java/net/minecraft/server/EntityArmorStand.java b/src/main/java/net/minecraft/server/EntityArmorStand.java
index 571ab5516a4f68d5c149e1319822b5bf889838ea..d3485346bdd8bd551daf5a45c82d2ba448008d3f 100644
--- a/src/main/java/net/minecraft/server/EntityArmorStand.java
+++ b/src/main/java/net/minecraft/server/EntityArmorStand.java
@@ -52,10 +52,12 @@ public class EntityArmorStand extends EntityLiving {
     private boolean noTickPoseDirty = false;
     private boolean noTickEquipmentDirty = false;
     // Paper end
+    public boolean canMovementTick = true; // Papercut
 
     public EntityArmorStand(EntityTypes<? extends EntityArmorStand> entitytypes, World world) {
         super(entitytypes, world);
         if (world != null) this.canTick = world.paperConfig.armorStandTick; // Paper - armour stand ticking
+        if (world != null) this.canMovementTick = world.papercutConfig.armorStandMovement; // Papercut
         this.handItems = NonNullList.a(2, ItemStack.b);
         this.armorItems = NonNullList.a(4, ItemStack.b);
         this.headPose = EntityArmorStand.bj;
@@ -630,6 +632,8 @@ public class EntityArmorStand extends EntityLiving {
                 this.updateEntityEquipment();
             }
 
+            this.movementTick(); // Papercut
+            this.updateInWaterStateAndDoWaterCurrentPushing(); // Papercut
             return;
         }
         // Paper end
@@ -883,4 +887,19 @@ public class EntityArmorStand extends EntityLiving {
         return true;
     }
     // Paper end
+
+    // Papercut start
+    // Mojang mapping: void updateInWaterStateAndDoWaterCurrentPushing() -> aL
+    private final void updateInWaterStateAndDoWaterCurrentPushing() { this.aL(); }
+    @Override
+    void aL() {
+        if (this.world.papercutConfig.armorStandWater && (!this.world.papercutConfig.armorStandWaterFence || !world.getType(getChunkCoordinates().down()).getBlock().isFence()))
+            super.aL();
+    }
+
+    @Override
+    public void movementTick() {
+        if (this.canMovementTick && this.canMove) super.movementTick();
+    }
+    // Papercut end
 }
diff --git a/src/main/java/us/minevict/papercut/PapercutConfig.java b/src/main/java/us/minevict/papercut/PapercutConfig.java
index 8e64b48663babd8cc335c2b0eebd4153486099c1..bb218d90234bb74da2ee885de91d6481079465ae 100644
--- a/src/main/java/us/minevict/papercut/PapercutConfig.java
+++ b/src/main/java/us/minevict/papercut/PapercutConfig.java
@@ -237,5 +237,14 @@ public final class PapercutConfig {
       enableZombieVillageAi = getBoolean("enable-ai.zombie-village", enableZombieVillageAi);
       enableZombieDestroyAi = getBoolean("enable-ai.zombie-destroy", enableZombieDestroyAi);
     }
+
+    public boolean armorStandMovement = true;
+    public boolean armorStandWater = true;
+    public boolean armorStandWaterFence = false;
+    private void armourStandMovement() {
+      armorStandMovement = getBoolean("armor-stand.movement", armorStandMovement);
+      armorStandWater = getBoolean("armor-stand.move-in-water", armorStandWater);
+      armorStandWaterFence = getBoolean("armor-stand.move-unless-fence", armorStandWaterFence);
+    }
   }
 }
