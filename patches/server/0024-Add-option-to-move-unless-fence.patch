From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Mariell Hoversholm <proximyst@proximyst.com>
Date: Mon, 9 Nov 2020 17:43:50 +0100
Subject: [PATCH] Add option to move unless fence

---
 src/main/java/net/minecraft/server/Block.java       | 13 +++++++++++++
 .../java/net/minecraft/server/EntityArmorStand.java |  3 ++-
 .../java/us/minevict/papercut/PapercutConfig.java   |  2 ++
 3 files changed, 17 insertions(+), 1 deletion(-)

diff --git a/src/main/java/net/minecraft/server/Block.java b/src/main/java/net/minecraft/server/Block.java
index 4b4f14711d483089a5d5478b57539911a9c7a2fc..6d73f04b2215469a10e6d9982df7e05b3dad3093 100644
--- a/src/main/java/net/minecraft/server/Block.java
+++ b/src/main/java/net/minecraft/server/Block.java
@@ -22,6 +22,19 @@ public class Block extends BlockBase implements IMaterial {
     });
     protected final BlockStateList<Block, IBlockData> blockStateList;
     private IBlockData blockData;
+    // Papercut start
+    public final boolean isFence() {
+        return this == Blocks.ACACIA_FENCE ||
+                this == Blocks.BIRCH_FENCE ||
+                this == Blocks.CRIMSON_FENCE ||
+                this == Blocks.DARK_OAK_FENCE ||
+                this == Blocks.JUNGLE_FENCE ||
+                this == Blocks.NETHER_BRICK_FENCE ||
+                this == Blocks.OAK_FENCE ||
+                this == Blocks.SPRUCE_FENCE ||
+                this == Blocks.WARPED_FENCE;
+    }
+    // Papercut end
     // Paper start
     public final boolean isDestroyable() {
         return com.destroystokyo.paper.PaperConfig.allowBlockPermanentBreakingExploits ||
diff --git a/src/main/java/net/minecraft/server/EntityArmorStand.java b/src/main/java/net/minecraft/server/EntityArmorStand.java
index bc22f0279a7f7696cc356ca1007281fb1ba1c504..fba7553d7de375b383a6f0c0c026e99497178165 100644
--- a/src/main/java/net/minecraft/server/EntityArmorStand.java
+++ b/src/main/java/net/minecraft/server/EntityArmorStand.java
@@ -891,7 +891,8 @@ public class EntityArmorStand extends EntityLiving {
     // Mojang mapping: void updateInWaterStateAndDoWaterCurrentPushing() -> aL
     @Override
     void aL() {
-        if (this.world.papercutConfig.armorStandWater) super.aL();
+        if (this.world.papercutConfig.armorStandWater && (!this.world.papercutConfig.armorStandWaterFence || !world.getType(getChunkCoordinates().down()).getBlock().isFence()))
+            super.aL();
     }
 
     @Override
diff --git a/src/main/java/us/minevict/papercut/PapercutConfig.java b/src/main/java/us/minevict/papercut/PapercutConfig.java
index cad3e3d67cbc6b360cefc3aa7a49d8320ae7dd82..bb218d90234bb74da2ee885de91d6481079465ae 100644
--- a/src/main/java/us/minevict/papercut/PapercutConfig.java
+++ b/src/main/java/us/minevict/papercut/PapercutConfig.java
@@ -240,9 +240,11 @@ public final class PapercutConfig {
 
     public boolean armorStandMovement = true;
     public boolean armorStandWater = true;
+    public boolean armorStandWaterFence = false;
     private void armourStandMovement() {
       armorStandMovement = getBoolean("armor-stand.movement", armorStandMovement);
       armorStandWater = getBoolean("armor-stand.move-in-water", armorStandWater);
+      armorStandWaterFence = getBoolean("armor-stand.move-unless-fence", armorStandWaterFence);
     }
   }
 }
